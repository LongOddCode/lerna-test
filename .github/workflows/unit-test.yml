name: Unit Test

on:
  pull_request:
    branches:
      - main
      - dev 

jobs:
  source-branch-test:
    runs-on: ubuntu-latest
    outputs:
      coverages: ${{ steps.unit-test.outputs.coverages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}

      - name: Setup node
        uses: actions/setup-node@v2.1.2
        with:
          node-version: 14

      - name: Setup jq
        shell: bash
        run:
          which jq

      - name: Setup project
        run: |
          npm run setup

      - name: Unit Test
        id: unit-test
        shell: bash
        run: |
          npx lerna run test:unit
          coverages="{}"
          for i in $(find . -name coverage-summary.json); do
            coverages=$(echo $coverages | jq -rc --arg package $(basename $(dirname $(dirname $i))) --argjson total $(jq -cr '.total' $i) '.[$package]= $total')
          done  
          echo "::set-output name=coverages::$coverages",

  target-branch-test:
    runs-on: ubuntu-latest
    outputs:
      coverages: ${{ steps.unit-test.outputs.coverages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.base_ref }}

      - name: Setup node
        uses: actions/setup-node@v2.1.2
        with:
          node-version: 14

      - name: Setup jq
        shell: bash
        run:
          which jq

      - name: Setup project
        run: |
          npm run setup

      - name: Unit Test
        id: unit-test
        shell: bash
        run: |
          npx lerna run test:unit
          coverages="{}"
          for i in $(find . -name coverage-summary.json); do
            coverages=$(echo $coverages | jq -rc --arg package $(basename $(dirname $(dirname $i))) --argjson total $(jq -cr '.total' $i) '.[$package]= $total')
          done  
          coverages=$(echo $coverages | jq -rc --argjson json '{"foo": "bar"}' '. + {foo: $json}')
          echo "::set-output name=coverages::$coverages",

  compare-coverage:
    needs: [source-branch-test, target-branch-test]
    runs-on: ubuntu-latest
    steps:
      - name: echo
        run: |
          mapfile -t source < <(echo ${{ needs.source-branch-test.outputs.coverages }} | jq -r 'keys[]' )

          for i in ${source[@]}; do
            if [[ $(echo ${{ needs.target-branch-test.outputs.coverages }} | jq .\"$i\") != "null" ]]; then
              targetpct=$(echo ${{ needs.target-branch-test.outputs.coverages }} | jq .\"$i\".lines.pct) 
              sourcepct=$(echo ${{ needs.source-branch-test.outputs.coverages }} | jq .\"$i\".lines.pct) 
              if (( $(echo "$targetpct > $sourcepct" | bc -l ) )); then
                printf "test coverage decreased: [target]%s, [source]%s\n"  $targetpct $sourcepct
                exit 1
              fi
            fi
          done
